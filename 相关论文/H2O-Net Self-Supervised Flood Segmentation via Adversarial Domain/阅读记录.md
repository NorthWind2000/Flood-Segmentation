# 一、Introduction

卫星数据的两个主要来源：政府卫星和商业卫星。

政府光学卫星往往配备各种各样的传感器（红色、绿色、蓝色、沿海气溶胶、红边（RE<sub>1</sub>、RE<sub>2</sub>）、近红外（NIR）、窄近红外、水汽、卷云、短波红外（SWIR<sub>1</sub>、SWIR<sub>2</sub>）），这些传感器通常用于洪水探测，但分辨率较低，且在给定区域内很少重访，从6天到16天不等。商业卫星通常只提供RGB + NIR图像，但提供更高分辨率的数据，重访时间为1天。这意味着洪水探测所必需的有用数据分辨率较低，在最佳条件下每6天只能提供一次，因此无法用于实时洪水预报和疏散警报。虽然商业卫星的重访时间短，这对实时洪水探测至关重要，但它们缺乏可靠的探测仪器。请注意，这两种来源均未提供水存在的直接指示或地面真实数据。

我们的方法旨在通过领域适应方法，利用这两个最佳资源，将政府卫星数据中的知识转移到商业卫星数据中，为近实时可用的高分辨率数据中的洪水分割提供基本工具。为了实现近实时洪水分割，这项工作解决了遥感和洪水探测系统中常见的两个挑战。

**本文解决的两个挑战：**

1. 缺乏像素级别的地面真实数据和注释困难，这是因为卫星图像中经常出现的复杂结构和障碍物，如小溪、云和云影；
2. 在高分辨率和高时间频率卫星图像中检测洪水。如前所述，洪水通常需要近实时检测，这只有在低延迟商业卫星中才可能实现，而且这些商业卫星没有配备足够可靠的仪器来检测是否存在水。我们通过学习使用注意力驱动的生成对抗网络，从低分辨率数据合成SWIR信号来解决这个问题，该网络连接到输入图像并馈送到一个改进的掩模监督的分割网络。

**本文主要贡献：**

1. 我们提出了一种称为H2O网络的方法，该方法在低分辨率数据（政府卫星图像）中学习SWIR信号合成，作为一种领域自适应机制，用于在高分辨率卫星图像中使用自我监控和标签细化进行精确洪水分割。
2. 我们提出了一个简单的运行时细化器，它利用我们的自适应距离映射方法生成从粗到精的掩模。
3. 在洪水分割方面，我们优于SOTA（state of the art）遥感和语义分割方法。

>**领域自适应**即**Domain Adaptation**是迁移学习中很重要的一部分内容，目的是把分布不同的源域和目标域的数据，映射到一个特征空间中，使其在该空间中的距离尽可能近。于是在特征空间中对source domain训练的目标函数，就可以迁移到target domain上，提高target domain上的准确率。

# 二、Related work

## 2.1 Computer Vision and Remote Sensing

​		**政府卫星sentinel-2和landsat-8以及商业卫星PlanetScope和WorldView的数据**在计算机视觉和遥感方面通常应用于土地覆盖分类、洪水探测、天气预报和精准农业。早期和当前工作使用阈值归一化水指数（NDWI）和修正归一化水指数（MNDWI）[19,81]进行永久性水分割，为随机森林提供快速可靠的地面真实数据，并使用支持向量机方法进行土地覆盖分类[11,76]和洪水检测[70]。最近公布的遥感数据集[69,14,5]鼓励了深度学习方法的发展，该方法在识别云和云影[87,79]、水[41,40]、洪水[13]和作物状况[4,3]方面的能力比基于阈值的算法在标记数据可用时更准确。

## 2.2 Semantic Segmentation

​		语义分割是一个基本的计算机视觉任务，全连接网络（FCN）（53）作为近年来语义分割方法的基础。编码器-解码器架构学习密集特征的最佳插值，以此来恢复原始分辨率并捕获场景细节。**U-Net[64]是一种值得注意的最新方法，它使用跳过连接来实现更好的特征传播，类似于[38]。PSP- Net、DeepLab和FPN[51、16、88]使用空间金字塔池化来获得对分割有用的多尺度上下文特征。**上下文特征的重要性在[85,86]中得到了进一步说明，它通过扩大的卷积扩大感受野，在不增加参数数量的情况下捕获更多上下文信息。**我们的方法使用U-Net作为分割网络，但实际上可以与任何其他分割方法集成。**

​		交互式切分[31,65,34,37,10,49,82,57,43]考虑用户提供的一组输入，通常是点或涂鸦，作为语义切分的指导。虽然我们的工作采用了交互分割中常见的元素，但它通过自动采样高置信度点作为用户输入来删除交互部分。虽然这消除了对用户输入的需要，但在图像完全或几乎完全被一个类覆盖的情况下，它可能会产生按类不平衡采样。我们通过使用我们的自适应距离贴图生成来解决这个问题，它考虑了类样本密度，允许更稳定的预测。

## 2.3 Domain Adaptation

**域自适应旨在将知识从标记的源域转移到未标记的目标域。**传统的领域适应工作侧重于分类和检测任务[67,75,30,54,55,74]，最近的工作显示了语义分割的进展[17,61,62,77]。**大多数领域适应模型由两个网络组成：一个用于特征适应学习，另一个用于任务学习。**在这里，我们的方式学习**从源域（低分辨率卫星数据）生成SWIR数据，并将这些知识转移到目标域（高分辨率卫星数据），以改进语义分割。**据我们所知，我们是第一个仅使用RGB输入实现此任务的人，也是第一个将此方法用作域自适应步骤的人。

## 2.4 Generative Models

​		近年来，领域适应背景下的生成模型得到了广泛关注。最初的方法使用StyleGAN和Pix2Pix[42,45]方法作为数据扩充步骤，通过修改纹理和外观学习领域不变特征[39,80]。最近的工作使用图像到图像的转换技术将一个域中可用的特征转移到另一个域，提供适用于目标域数据的附加数据[80,15,84,61]。

​		StandardGAN[72]建立在StyleGAN的基础上，通过在卫星数据中强制使用类似的样式来标准化输入，以减少域差距。DUNIT[12]首先通过从样式图像生成样式特征，将源图像和目标图像中的样式和内容结合起来，并将它们连接到内容域中的特征，作为第三个生成器的输入。**与我们的工作最接近的方法是S2A[66]，它使用Wasserstein GAN[8]合成SWIR信号，并使用高膨胀和空间注意模块放大感受野。**

​		我们的方法仅使用RGB输入进行SWIR合成，由于存在较大的域间距，使得任务更加复杂，但也更适用于使用航空或卫星图像且不包含NIR数据的其他域。由于通过阈值生成地面真实值通常是有噪声的，因此像素标签容易受到常见误报的影响，从而使评估数据不可靠。在这项工作中，我们将合成SWIR信号的任务定义为高分辨率卫星图像洪水分割的域自适应步骤。我们手动注释由SWIR信号引导的测试数据集，以经验性地评估我们的结果。据我们所知，这项工作是第一次尝试从视觉线索学习SWIR信号，并将其转移到高分辨率域进行语义分割。

# 三、H2O Network

## 3.1 Remote Sensing Overview

Landsat和Sentinel-2等中等分辨率传感器检测淹没通常依赖于SWIR和NIR波段的吸水率。一种常用的水指数MNDWI计算绿色和SWIR波段之间的标准化差，以强调地表水并减少土壤和建筑区的噪音[81]。MNDWI是对NDWI的显著改进，NDWI依赖于绿色和NIR波段之间的归一化差异[58]。**这种改进主要源于SWIR2未受干扰的大气窗口，通常出现在波长较长的信号中，因为它们更容易穿透大气。然而，在大多数商用传感器中，SWIR2 波段明显缺失。**

## 3.2 Problem Formulation and Overview

这项工作的目的是学习低分辨率图像$ X_{LR}\in R^{H\times W\times 3}$和SWIR图像$S\in R^{H\times W\times 1}$之间的一个映射，以提升高分辨率卫星数据的语义分割预测$\hat{Y}\in R^{H\times W\times C}$。因为在没有ground truth的高分辨率图像上直接分割是一个挑战（$X_{HR}=>\hat{Y}_{HR}$），**我们通过学习与水存在高度相关的信号作为域适应步骤来弥合这一差距。在分割训练期间，我们添加了一种自我监督方法，使用经典遥感方法获得的粗标签$Y_C$的动态掩模细化，并使用我们的轻型细化器网络进行细化。**在训练期间，网络学习$X_{LR}=>\hat{S}_{LR}=>\hat{Y}_{LR}$，并将其应用到高分辨率数据上$X_{HR}=>\hat{S}_{HR}=>\hat{Y}_{HR}$。

## 3.3 SWIR-Synth Network

SWIR-Synth是一个图像到图像转换的生成对抗网络，我们的目标是将图像从光学领域转换到更长波长领域。

设$x\in R^{H\times W\times 3}$是原领域的图像，$s\in R^{H\times W\times 1}$是x在SWIR中的映射。

网络$G_{SWIR-Synth}$通过最小化总损失函数L，以寻求$SWIR_2$合成信号 $\hat{s}=G_{SWIR-Synth}(x)$。
$$
L_{GAN}(S,\hat{S})=\lambda_0L_G(S,\hat{S})+\lambda_1L_D(S,\hat{S})+\lambda_2L_F(S,\hat{S}))
$$

> $L_G,L_D,L_F$是生成者、辨别者和特征匹配的损失。$\lambda_*$是损失的权重。

**Generator Loss**

生成者G要通过最小化两个目标函数来学习输出$\hat{s}$：$s\in S$ 和$\hat{s}\in \hat{S}$之间的像素级平方误差，以及所生成数据的鉴别器输出的patch级平方误差。第一个目标是惩罚RGB到$SWIR_2$不准确的映射，第二个目标是惩罚被鉴别器视为“假”的patch。
$$
L_G(S,\hat{S})=E=(||s-\hat{s}||_2)+E(||1-D(\hat{s})||_2)
$$
**Adversarial Loss**

当鉴别器将合成数据识别为真实数据时， SWIR-Synth将会得到奖励，这样能够产生更真实的合成数据。我们使用了一个马尔可夫鉴别器（PatchGAN），该鉴别器在[48]中进行了深入探讨，其中鉴别器旨在对生成图像的N×N 个子块进行分类，每个块被分类为“真”或“假”。

鉴别器的最终优化目标是：
$$
L_D(S,\hat{S})=E=(||D\hat{s}||_2)+E(||1-D(s)||_2)
$$
**Feature Matching Loss**

卫星图像中经常出现的难以学习的潜在模式会导致模型训练不稳定，我们使用[68]中介绍的特征匹配损失来解决这一问题。**我们从鉴别器倒数第二层提取真实和合成样本的特征，并最小化它们之间的平方距离。**

优化函数：
$$
L_F(S,\hat{S})=E(||D^{[n-1]}(s)-D^{[n-1]}(\hat{s})||_2)
$$

>n 表示鉴别器D中的层数
>
>$D^{[n-1]}(.)$表示鉴别器第n-1层的输出

## 3.4 Refiner/Self-Supervision

​		这项工作介绍了一个运行时细化器，它能够在批输入上进行泛化，以改进通过MNDWI阈值获得的粗掩模。令样本（$x\in R^{H\times W\times 3},m\in R^{H\times W\times 1}$）是image-MNDWI对。

​		我们使用高阈值和低阈值（$\phi_H和\phi_L$）定义高置信度水和非水像素，以此在m上获得一组位置$(p_{wx},p_{wy}) \in P_{w},(p_{\tilde{w}x},p_{\tilde{w}y})\in P_{\tilde{w}}$），对应于水（正）和非水（负）点。然后使用距离映射函数将$ P_{w} 和 P_{\tilde{w}}$分别转换为距离映射$D_{w}\in R^{H\times W\times 1} 和D_\tilde{w}\in R^{H\times W\times 1}$。距离映射是通过取一个正点和一组负点之间的最小欧几里德距离来计算的。

例如：为了获得距离映射$D_w$，我们使用公式$D(x,y|P_{w})=min_{\forall p_{wx},p_{wy}}\sqrt{(x-p_{wx})^2+(y-p_{wy})^2}$，计算点集$p_{w}$的$(i,j)$处的像素值$D_{w}^{i,j}$，其中(x,y)是图像中的任意一点。重复此操作，直到获得$D_w和D_{\tilde{w}}$中的所有像素的距离值。

​		在洪水事件数据集中，类很少以相似的量级出现，通常导致一个类的采样点稀疏，而另一类的采样点密集。我们将自适应距离图$D_a$定义为密集采样点的距离图，进行归一化，使较高的值表示正类（水），较低的值表示负类（非水）。然后，我们通过连接MNDWI、m和自适应距离图$D_a$来构造网络输入I，并使用它训练我们的细化器网络。

细化器网络要最小化：
$$
L_R(P_w,P_{\tilde{w}},\tilde{y})=-\sum_{p_w}log(\tilde{y})-\sum_{p_\tilde{w}}{(1-log(\tilde{y}))}
$$

>注意：loss函数忽略那些不在$P_w \cup P_\tilde{w}$中的像素

**在网络进行k次迭代训练后，它可以在同一张图像上预测出其余像素（先前利用高阈值和低阈值忽略的像素）mask，从而生成一个伪ground truth mask $\tilde{Y}_R$，并反馈给分割网络。这种方法背后的原理是，给定一组小的高置信度标记像素，可以预测整个图像的标签。**

## 3.5 Segmentation Network

编码器-解码器体系结构将RGB图像X和合成SWIR图像$\tilde S$连接成4通道作为输入，旨在预测像素级标签$\tilde Y$，以最大限度地减少$\tilde Y和Y_R$之间的交叉熵损失。

模型损失函数定义为：
$$
L_S(Y_R,\tilde{Y})=-\sum log(\tilde{Y})-\sum{(1-log(\tilde{Y}))}
$$
该网络的作用有两个：

- 当水标签不存在时，它通过惩罚低合成SWIR值来微调SWIR-Synth网络；
- 它可以学习将RGB和SWIR输入对关联到水像素。
